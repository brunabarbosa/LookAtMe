<!DOCTYPE>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Look At Me</title>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
		<link rel="stylesheet" href="css/default.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ==" crossorigin="anonymous"></script>
		<script src="js/lookatme.js"></script>
	</head>
	<body>
		<div class="container">
			<nav class="navbar navbar-default navbar-inverse navbar-fixed-top" role="navigation">
				<div class="container-fluid">
					<div class="navbar-header navbar-left">
						<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded=false></button>
						<a class="navbar-brand" href="main.html"><img alt="Look At Me" src="img/logo-xs.png" /></a>
					</div>
					<div id="navbar-collapse" class="collapse navbar-collapse text-center">
						<ul class="nav navbar-nav navbar-right">
							<li><img id="avatar" class="img-circle" src="img/default-avatar.jpg" /></li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span id="name"></span> <span class="caret"></span></a>
								<ul class="dropdown-menu">
									<li><a href="#" id="logout">Sair</a></li>
								</ul> 
							</li><!-- .dropdown -->
						</ul><!-- .navbar-nav -->
					</div><!-- .navbar-collapse -->
				</div><!-- .container-fluid -->
			</nav><!-- .nav -->
			<nav class="navbar navbar-default navbar-inverse navbar-fixed-bottom">
				<div class="container-fluid">
					<form id="question-form-simplified">
						<div class="input-group">
							<input type="text" class="form-control" placeholder="Digite aqui uma nova pergunta" autofocus id="question-title" />
							<span class="input-group-btn"><button type="submit" class="btn btn-warning" id="new-question">Enviar</button></span>
						</div>
					</form>
				</div>
			</nav>
			<div class="divider"></div>
			<div class="panel panel-default">
				<div class="panel-heading">
					Últimas perguntas
				</div>
				<ul id="questions" class="list-group">
				</ul>
			</div><!-- .panel -->
			<div class="divider"></div>
		</div><!-- .container -->
		<div class="modal fade" id="question-modal">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Fechar"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Nova pergunta</h4>
					</div>
					<form id="question-form" type="post" enctype="multipart/form-data">
						<div class="modal-body">
							<p class="alert alert-danger" id="error" style="display: none;"></p>
							<div class="form-group">
								<input type="text" class="form-control" id="title" name="title" placeholder="Título da pergunta" maxlength="100" minlength="3" autofocus required />
							</div>
							<div class="form-group">
								<textarea class="form-control" id="description" name="description" placeholder="Descrição" maxlength="300"></textarea>
							</div>
							<div class="form-group">
								<input type="file" id="images" name="images" multiple accept="image/x-png, image/gif, image/jpeg">
							</div>
							<div id="images-container">
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
							<input type="submit" id="send" class="btn btn-warning" value="Enviar" data-loading-text="Enviando..." autocomplete="off" />
						</div>
					</form>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		<a href="#" class="list-group-item" id="question-template" style="display: none;">
			<table class="question">
				<tr>
					<td class="question-title">
						<a href="#"></a>
					</td>
					<td class="question-icons" rowspan="3">
						<span class="badge question-comments"></span>
						<span class="glyphicon glyphicon-star star" aria-hidden="true"></span>
					</td>
				</tr>
				<tr>
					<td class="question-description"></td>
				</tr>
				<tr>
					<td class="question-time">Postado por <a href="#" class="question-author"></a> às <span class="question-date"></span></td>
				</tr>
			</table>
		</a>
		<script>
			// Update the list of most recent questions
			function update_list() {
				$("#questions").append('<li class="list-group-item" id="loading"><img class="loading" src="img/loading.gif" /></li>');
				$.ajax({
					type: 'get',
					url: SERVER_URL + "question/last.php",
					cache: false,
					success: function(jsonObj) {
						$("#loading").fadeOut(function() {
							if (jsonObj.success) {
								$("#questions").html("");
								if (jsonObj.result.length == 0) {
									$("#questions").append("<li class='list-group-item'>Não há questões criadas no momento. <a href='#' id='create-question' role='button'>Seja o primeiro a criar</a>.</li>");
								} else {
									for (var i = 0; i < jsonObj.result.length; i++) {
										var questionObj = jsonObj.result[i];
										var $question = $("#question-template").clone();
										$question.attr("id", "");
										$question.attr("href", "view_question.html?id=" + questionObj.id);
										$question.find(".question-title a").html(questionObj.title);
										$question.find(".question-title a").attr("href", "view_question.html?id=" + questionObj.id);
										$question.find(".question-description").html(questionObj.description);
										$question.find(".question-author").html(questionObj.user_name);
										$question.find(".question-date").html(questionObj.creation_date);
										if (questionObj.num_comments <= 1) {
											$question.find(".question-comments").html(questionObj.num_comments + " comentário");
										} else {
											$question.find(".question-comments").html(questionObj.num_comments + " comentários");
										}
										if (questionObj.has_favorite) {
											$question.find(".glyphicon-star").removeClass("star");
											$question.find(".glyphicon-star").addClass("star-active");
										}
										$("#questions").append($question);
										$question.fadeIn();
									}
								}
							} else {
								$("#questions").append("<li class='list-group-item alert alert-danger'>" + jsonObj.message + "</li>");
							}
						});
					}, 
					error: function(msg) {
						$("#loading").fadeOut(function() {
							$("#questions").html("");
							$("#questions").append("<li class='list-group-item alert alert-danger'>" + msg + "</li>");
						});
					}
				});
			}
			$(function() {
				// Fill questions 
				update_list();
				// Open new question modal 
				$("#new-question").click(function() {
					$("#question-modal").modal("show");
					$("#question-form")[0].reset();
					$("#images-container").html("");
					$("#question-form input[name='title']").val($("#question-title").val());
					$("#question-form input[name='description']").focus();
				});
				// Insert question images preview 
				$("#question-form input[type='file']").on("change", function() {
					$("#images-container").html("");
					$.each($(this)[0].files, function(i, file) {
						var fr = new FileReader();
						fr.onload = function(ev) {
							var $elem = $("<img class='img-thumbnail' src='" + ev.target.result + "' />");
							$elem.hide();
							$("#images-container").append($elem);
							$elem.fadeIn();
						};
						fr.readAsDataURL(file);
					});
				});
				// Open the modal upon sending the simplified form 
				$("#question-form-simplified").submit(function(e) {
					e.preventDefault();
					$("#question-modal").modal("show");
					setTimeout(function() {
						$("#description").focus();
					}, 500);
				});
				$("#question-modal").on("show.bs.modal", function() {
					$("#error").html("");
					$("#error").hide();
				});
				// Submit a new question form 
				$("#question-form").submit(function(e) {
					e.preventDefault();
					$("#send").button("loading");
					var request = new FormData();
					var count = 0;
					$.each($("#images")[0].files, function(i, file) {
						request.append("image_" + i, file);
						count++;
					});
					request.append("email", user.email);
					request.append("title", $("#title").val());
					request.append("description", $("#description").val());
					request.append("num_images", count);
					$.ajax({
						type: 'post',
						url: SERVER_URL + "question/create.php",
						cache: false,
						contentType: false,
						processData: false,
						data: request,
						success: function(jsonObj) {
							console.log(jsonObj);
							if (jsonObj.success) {
								$("#question-modal").modal("hide");
								$("#question-form")[0].reset();
								$('html, body').animate({ scrollTop: 0 }, 'slow');
								update_list();
							} else {
								$("#error").html(json.message);
								$("#error").show();
							}
							$("#send").button("reset");
						},
						error: function(msg) {
							$("#error").html(msg);
							$("#error").show();
							$("#send").button("reset");
						}
					});
				});
				$(document).on("click", "#create-question", function() {
					$("#question-modal").modal("show");
					setTimeout(function() {
						$("#title").focus();
					}, 500);
				});
			});
		</script>
	</body>
</html>